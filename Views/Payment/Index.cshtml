@using System.Data
@using ShippingComp.ViewModels
@model PaymentsDataTable_With_ClientsListViewModel

@{
    ViewBag.Title = "Index";
}

<style>
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    table {
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        overflow: hidden;
        width: 100%;
        padding: 20px;
    }
</style>

<h2 class="">Payments Index</h2>

<div class="my-3">
    <label>Filter by client</label>
    <select id="filterByClient">
        <option>all</option>
        @foreach (DataRow row in Model.Clients.Rows)
        {
            <option>@row.ItemArray[1]</option>
        }
    </select>
</div>

<table class="table table-bordered table-hover table-container">
    <thead>
        <tr>
            @foreach (DataColumn col in Model.Payments.Columns)
            {
                <th>@col.ColumnName</th>
            }
        </tr>
    </thead>
    <tbody id="filteredtBody">
        @foreach (DataRow row in Model.Payments.Rows)
        {
            <tr id="@row.ItemArray[0]" class="invoiceRow">
                @foreach (var item in row.ItemArray)
                {
                    <td>@item</td>
                }
            </tr>
        }
    </tbody>
</table>

<div id="invoiceDetails" style="display:flex">
    <button id="invoiceDetailsCloseBtn" class="btn btn-close mt-1 me-2"></button>
    <div id="the_table"></div>
</div>


<!-- Button trigger modal -->
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
    Add payment
</button>

<!-- Modal -->
<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="Modaltitle">Check Invoice Id First!</h1>
                <button type="button" id="closeModal" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form class="container mt-4">
                    <div id="checkInvoiceExist">
                        <div class="row mb-3">
                            <div class="col-md-4 col-sm-4">
                                <label class="form-label">Invoice Id</label>
                            </div>
                            <div class="col-md-6 col-sm-8">
                                <input type="number" name="invoiceid" id="invoiceid" class="form-control" />
                            </div>
                            <div class="col-md-6 col-sm-8">
                                <span id="invoice_check_span" class="text-danger"></span>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" id="checkInvoiceExistBtn">Check</button>
                        <button type="button" class="btn btn-primary" id="proceedToPay">Proceed to pay</button>
                    </div>
                    <div id="addPayment">
                        <div class="row mb-3">
                            <div class="col-md-4 col-sm-4">
                                <label class="form-label">Amount</label>
                            </div>
                            <div class="col-md-6 col-sm-8">
                                <input type="number" name="amountpaid" id="amountpaid" class="form-control" />
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 col-sm-4">
                                <label class="form-label">Payment Date</label>
                            </div>
                            <div class="col-md-6 col-sm-8">
                                <input type="date" name="paymentdate" id="paymentdate" class="form-control" />
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" id="submitPayment">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>






<script>
    $(document).ready(function () {
        $("#PaymentsTab > a").addClass("active");


        //user chooses client name to filter payments table
        $("#filterByClient").change(function () {
            $.ajax({
                url: "/payment/FilterPaymentsByClient",
                type: 'get',
                data: { client_name: this.value },
                dataType: 'html',
                success: function (response) {
                    $("#filteredtBody").html(response);
                },
                error: function (error) {
                    console.log(error);
                }
            });
        });


        $("#addPayment").hide(); //hide new payment inputs to check if invoice exists or not
        $("#proceedToPay").hide();
        $("#invoiceDetails").hide();


        var invoiceId;

        $("#checkInvoiceExistBtn").click(function () {
            invoiceId = $("#invoiceid").val();
            if (invoiceId != '') {
                $.ajax({
                    url: `/invoice/CheckInvoiceExistThenStatus/${invoiceId}`,
                    type: 'get',
                    success: function (res) {
                        console.log(res);
                        if (res == -1) {
                            $("#proceedToPay").hide();
                            $("#invoice_check_span").text("There is NO invoice with this id");
                        }
                        else if (res == -2) {
                            $("#proceedToPay").hide();
                            $("#invoice_check_span").text("This invoice is fully paid");
                        }
                        else {
                            $("#invoice_check_span").text("amount to pay is: " + res);
                            $("#checkInvoiceExistBtn").show();
                            $("#proceedToPay").show();
                        }
                    },
                });
            }
        });

        $("#proceedToPay").click(function () {
            $("#addPayment").show();
            $("#checkInvoiceExist").hide();
        });

        $("#submitPayment").click(function () {
            var amountPaid = $("#amountpaid").val();
            var paymentDate = $("#paymentdate").val();

            if (amountPaid == '' || paymentDate == '') {
                console.log("data aint complete to make this payment my dawg");
            }
            else {
                console.log(paymentDate);

                $.ajax({
                    url: "/payment/AddPayment",
                    type: "post",
                    data: {
                        invoiceId,
                        amountPaid,
                        paymentDate
                    },
                    success: function (response) {
                        $("#filteredtBody").html(response);
                        $("#closeModal").trigger('click');
                    },
                });

                console.log("payment done successfully with these data:");
                console.log(invoiceId);
                console.log(amountPaid);
                console.log(paymentDate);
                $("#amountpaid").val('');
                $("#paymentdate").val('');
            }
        });

        $(".invoiceRow").click(function () {
            var id = $(this)[0].attributes[0].value;
            console.log(id);

            $.ajax({
                url: `/payment/GetAllPaymentsForThisInvoice/${id}`,
                type: "post",
                success: function (res) {
                    $("#the_table").html(res);
                },
            });
            $("#invoiceDetails").show();
        });

        $("#invoiceDetailsCloseBtn").click(function () {
            console.log("close btn clicked");
            $("#the_table").html("");
            $("#invoiceDetails").hide();
        });

    });
</script>

